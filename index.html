<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Boss It POS</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>
    <script type="application/javascript" src="mapbox_utils.js"></script>
    <link type="text/css" rel="stylesheet" href="styles.css">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#262626">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" href="icons/icon-48x48.png"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="KDS">
    <script src="version.js"></script>
    <script>
        document.write(`<script type="application/javascript" src="composeApp-${APP_VERSION}.js"><\/script>`);
    </script>
    <script>
        function createUpdateOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'updateOverlay';
            overlay.className = 'update-overlay';
            
            overlay.innerHTML = `
                <img src="icons/icon-192x192.png" alt="Boss It Logo" class="update-logo">
                <div class="update-spinner"></div>
            `;
            
            return overlay;
        }
        
        function showUpdateScreen() {
            if (document.getElementById('updateOverlay')) return;
            
            const overlay = createUpdateOverlay();
            document.body.appendChild(overlay);
            
            requestAnimationFrame(() => {
                overlay.classList.add('visible');
            });
            
            console.log('Update screen shown');
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                        
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker found');
                            
                            if (navigator.serviceWorker.controller) {
                                showUpdateScreen();
                            }
                            
                            newWorker.addEventListener('statechange', () => {
                                console.log(`SW state changed: ${newWorker.state}`);
                                
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        console.log('New service worker installed, activating...');
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    } else {
                                        console.log('Service worker installed for the first time');
                                    }
                                }
                            });
                        });
                        
                        let refreshing = false;
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            if (refreshing) return;
                            refreshing = true;
                            console.log('New service worker activated, reloading page...');
                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        window.addEventListener('online', () => {
            console.log('App is online');
        });
        
        window.addEventListener('offline', () => {
            console.log('App is offline');
        });
    </script>
</head>
<body>
    <canvas id="ComposeTarget"></canvas>
    <div id="components"></div>
</body>
</html>